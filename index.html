<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>DeltaMobile Ops</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React Core & Dependencies (UMD) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-is@18.2.0/umd/react-is.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 3. Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background-color: #000000; 
            color: #e5e5e5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .h-dvh { height: 100dvh; }
        .touch-manipulation { touch-action: manipulation; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { display: none; }
        .animate-spin-slow { animation: spin 20s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-alert { animation: pulse-red 1.5s infinite; }
    </style>
</head>
<body class="h-dvh flex flex-col">
    <div id="root" class="flex-1 flex flex-col h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;
        const RechartsLib = window.Recharts || {};
        const { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip } = RechartsLib;

        const Icon = ({ name, size = 24, className, color }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons({ 
                    root: iconRef.current, name, attrs: { width: size, height: size, class: className, stroke: color || "currentColor" } 
                });
            }, [name, size, className, color]);
            return <i ref={iconRef} className="flex items-center justify-center"></i>;
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDXDzgJ_12pNFStd3_mEEUPzzcGe9VcEkM",
            authDomain: "deltratracker.firebaseapp.com",
            projectId: "deltratracker",
            storageBucket: "deltratracker.firebasestorage.app",
            messagingSenderId: "283313664204",
            appId: "1:283313664204:web:f7cda26e9f1edfd6e95269"
        };

        let auth, db;
        let isConfigLoaded = false;
        
        if (window.firebase && FIREBASE_CONFIG) {
            try {
                if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                db.enablePersistence({ synchronizeTabs: true }).catch(err => console.log("Persistência offline:", err.code));
                isConfigLoaded = true;
            } catch (e) { console.error("Erro Firebase:", e); }
        }

        const STAGE_COLORS = { 'Lei Seca': '#f59e0b', 'Teoria': '#3b82f6', 'Questões': '#10b981', 'Jurisprudência': '#8b5cf6' };
        
        const SUBJECT_COLORS = {
            'Direito Penal': 'text-rose-400',
            'Processo Penal': 'text-amber-400',
            'LPE': 'text-purple-400',
            'Constitucional': 'text-blue-400',
            'Administrativo': 'text-cyan-400',
            'Lei': 'text-emerald-400'
        };

        const TOPICS_BY_SUBJECT = {
            'Direito Penal': ['Teoria do Crime', 'Crimes Contra a Vida', 'Crimes Patrimoniais', 'Crimes Contra a Adm. Pública', 'Concurso de Pessoas', 'Penas', 'Extinção da Punibilidade'],
            'Processo Penal': ['Inquérito Policial', 'Prisões e Liberdade', 'Provas', 'Ação Penal', 'Competência', 'Nulidades', 'Recursos'],
            'LPE': ['Lei de Drogas', 'Maria da Penha', 'Organização Criminosa', 'Estatuto do Desarmamento', 'Abuso de Autoridade', 'Crimes Hediondos', 'Tortura'],
            'Constitucional': ['Direitos Fundamentais', 'Segurança Pública', 'Organização do Estado', 'Poder Executivo', 'Controle de Constitucionalidade', 'Poder Judiciário', 'Ordem Social'],
            'Administrativo': ['Agentes Públicos', 'Poderes Administrativos', 'Atos Administrativos', 'Resp. Civil do Estado', 'Organização Administrativa', 'Licitações', 'Controle da Adm.'],
            'Lei': ['Código Civil', 'Processo Civil', 'Direito Tributário', 'Direito Ambiental', 'Estatuto da Criança e Adolescente', 'Código de Defesa do Consumidor', 'Legislação Esparsa']
        };
        
        const SUBJECTS = Object.keys(TOPICS_BY_SUBJECT);
        const STAGES = Object.keys(STAGE_COLORS);

        // --- FUNÇÕES GLOBAIS DE FORMATAÇÃO ---
        const formatDuration = (mins) => {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            if (h > 0) return `${h}h${m.toString().padStart(2, '0')}m`;
            return `${m}m`;
        };

        const formatTime = (s) => {
            const m = Math.floor(s / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            return `${m}:${sec}`;
        };

        const getLocalISODate = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const playAlert = () => {
            try {
                if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'square'; 
                osc.frequency.setValueAtTime(880, ctx.currentTime);
                osc.frequency.setValueAtTime(440, ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 1);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 1);
                if (Notification.permission === 'granted') new Notification("DeltaTracker", { body: "Tempo Esgotado!" });
            } catch (e) { console.error("Erro audio", e); }
        };

        // --- COMPONENTES VISUAIS ---

        const TimerView = ({ 
            user, isCloudActive, connectionStatus, runDiagnostics, 
            entryMode, setEntryMode, isRunning, time, initialTime, 
            subject, setSubject, stage, setStage, topic, setTopic, manualDate, setManualDate, 
            manualHours, setManualHours, manualMins, setManualMins, qDone, setQDone, qCorrect, setQCorrect, 
            resetTimer, handleSave, setIsRunning, formatTime, pauseTimer, startTimer,
            forceLogin
        }) => (
            <div className="flex flex-col h-full p-6 pt-safe fade-in">
                <div className="flex justify-between items-center mb-6">
                    <button 
                        onClick={runDiagnostics}
                        className="flex items-center gap-2 active:opacity-50 transition-opacity"
                    >
                        <div className={`w-2 h-2 rounded-full ${connectionStatus === 'online' ? 'bg-emerald-500 shadow-[0_0_8px_#10b981]' : connectionStatus === 'connecting' ? 'bg-blue-500 animate-pulse' : 'bg-yellow-500'}`}></div>
                        <span className={`text-[10px] font-bold tracking-widest ${connectionStatus === 'online' ? 'text-slate-500' : 'text-yellow-500'}`}>
                            {connectionStatus === 'online' ? 'OPS.ONLINE' : connectionStatus === 'connecting' ? 'CONECTANDO...' : 'LOCAL/OFF'}
                        </span>
                    </button>
                    <div className="text-[10px] text-slate-600 font-mono">ID: {user && user.uid !== 'local' ? user.uid.slice(0,4) : 'LOC'}</div>
                </div>

                <div className="bg-slate-900 p-1.5 rounded-xl flex mb-6 border border-slate-800">
                    <button onClick={() => setEntryMode('timer')} className={`flex-1 py-3 text-sm font-bold rounded-lg transition-all ${entryMode === 'timer' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500'}`}>TIMER</button>
                    <button onClick={() => setEntryMode('manual')} className={`flex-1 py-3 text-sm font-bold rounded-lg transition-all ${entryMode === 'manual' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-500'}`}>MANUAL</button>
                </div>

                <div className="flex-1 flex flex-col items-center justify-start relative">
                    {entryMode === 'timer' ? (
                        <div className="flex flex-col items-center w-full">
                            <div className="relative w-56 h-56 md:w-64 md:h-64 flex items-center justify-center mb-6">
                                <svg className="absolute inset-0 w-full h-full animate-spin-slow opacity-40" viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="48" fill="none" stroke="currentColor" strokeWidth="0.5" strokeDasharray="4 4" className="text-slate-500" />
                                    <path d="M50 2 L50 10 M50 90 L50 98 M2 50 L10 50 M90 50 L98 50" stroke="currentColor" strokeWidth="1" className="text-slate-600" />
                                </svg>
                                <svg className="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="42" fill="none" stroke="#1e293b" strokeWidth="4" />
                                </svg>
                                <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="42" fill="none" stroke={time === 0 ? '#ef4444' : isRunning ? '#3b82f6' : '#334155'} strokeWidth="4" strokeDasharray={2 * Math.PI * 42} strokeDashoffset={2 * Math.PI * 42 * (1 - (initialTime - time) / initialTime)} strokeLinecap="round" className="transition-all duration-1000"/>
                                </svg>
                                <div className="z-10 flex flex-col items-center">
                                    <div className={`text-4xl font-mono font-bold tracking-tighter ${time === 0 ? 'text-red-500 animate-pulse' : isRunning ? 'text-blue-400' : 'text-slate-200'}`}>
                                        {formatTime(time)}
                                    </div>
                                    <div className="text-[10px] text-slate-500 font-bold tracking-[0.2em] mt-2">
                                        {isRunning ? 'EM CURSO' : 'PAUSADO'}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-4 gap-2 mb-4 w-full px-2">
                                {!isRunning && (
                                    <>
                                        <button onClick={() => resetTimer(30*60)} className="py-3 bg-slate-900 rounded-xl text-sm font-bold text-slate-400 border border-slate-800 active:bg-slate-800">30m</button>
                                        <button onClick={() => resetTimer(50*60)} className="py-3 bg-slate-900 rounded-xl text-sm font-bold text-slate-400 border border-slate-800 active:bg-slate-800">50m</button>
                                        <button onClick={() => resetTimer(60*60)} className="py-3 bg-slate-900 rounded-xl text-sm font-bold text-slate-400 border border-slate-800 active:bg-slate-800">60m</button>
                                        <button onClick={() => {
                                            const custom = prompt("Defina os minutos (ex: 45):");
                                            if(custom && !isNaN(custom) && custom > 0) resetTimer(parseInt(custom)*60);
                                        }} className="py-3 bg-slate-900 rounded-xl text-sm font-bold text-blue-500 border border-slate-800 active:bg-slate-800">Livre</button>
                                    </>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col space-y-4 animate-fade-in w-full">
                            <div className="bg-slate-900 border border-slate-800 rounded-xl p-4 flex items-center justify-between">
                                <label className="text-[10px] font-bold text-slate-500 uppercase">Data</label>
                                <input type="date" value={manualDate} onChange={e=>setManualDate(e.target.value)} className="bg-transparent text-white text-right outline-none text-sm font-bold appearance-none"/>
                            </div>
                            
                            <div className="flex gap-3">
                                <div className="bg-slate-900 border border-slate-800 rounded-xl p-4 flex-1 flex flex-col items-center">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase mb-1">Horas</label>
                                    <input type="number" value={manualHours} onChange={e=>setManualHours(e.target.value)} className="bg-transparent text-white w-full outline-none text-xl font-mono font-bold text-center placeholder-slate-700" placeholder="0"/>
                                </div>
                                <div className="bg-slate-900 border border-slate-800 rounded-xl p-4 flex-1 flex flex-col items-center">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase mb-1">Minutos</label>
                                    <input type="number" value={manualMins} onChange={e=>setManualMins(e.target.value)} className="bg-transparent text-white w-full outline-none text-xl font-mono font-bold text-center placeholder-slate-700" placeholder="0"/>
                                </div>
                            </div>

                            {entryMode === 'manual' && (
                                <div className="grid grid-cols-2 gap-3">
                                    <select value={subject} onChange={e=>setSubject(e.target.value)} className="bg-black border border-slate-700 text-white p-3 rounded-xl outline-none font-bold text-xs w-full">
                                        {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <select value={stage} onChange={e=>setStage(e.target.value)} className="bg-black border border-slate-700 text-white p-3 rounded-xl outline-none font-bold text-xs w-full">
                                        {STAGES.map(s=><option key={s} value={s}>{s}</option>)}
                                    </select>
                                </div>
                            )}

                            {entryMode === 'manual' && (
                                    <input type="text" placeholder="Tópico (Opcional)" value={topic} onChange={e=>setTopic(e.target.value)} className="w-full bg-black border border-slate-700 text-white p-3 rounded-xl outline-none text-sm"/>
                            )}

                            {stage === 'Questões' && entryMode === 'manual' && (
                                <div className="grid grid-cols-2 gap-3">
                                    <input type="number" placeholder="Feitas" value={qDone} onChange={e=>setQDone(e.target.value)} className="bg-black border border-slate-700 p-3 rounded-xl text-white text-center outline-none focus:border-emerald-500 text-sm"/>
                                    <input type="number" placeholder="Acertos" value={qCorrect} onChange={e=>setQCorrect(e.target.value)} className="bg-black border border-slate-700 p-3 rounded-xl text-emerald-400 font-bold text-center outline-none focus:border-emerald-500 text-sm"/>
                                </div>
                            )}
                        </div>
                    )}
                </div>

                <div className="mt-auto space-y-3 pt-4 border-t border-slate-800/50">
                    {/* Controles do Timer - Sempre Visíveis */}
                    {entryMode === 'timer' && (
                        <div className="flex flex-col gap-3">
                             {time === initialTime && (
                                <div className="grid grid-cols-2 gap-3 mb-2 animate-fade-in">
                                    <select value={subject} onChange={e=>setSubject(e.target.value)} className="bg-slate-900 border border-slate-800 text-white p-4 rounded-xl outline-none appearance-none font-bold text-xs truncate">
                                        {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <select value={stage} onChange={e=>setStage(e.target.value)} className="bg-slate-900 border border-slate-800 text-white p-4 rounded-xl outline-none appearance-none font-bold text-xs">
                                        {STAGES.map(s=><option key={s} value={s}>{s}</option>)}
                                    </select>
                                </div>
                             )}
                             {time === initialTime && (
                                 <div className="relative mb-2 animate-fade-in">
                                    <input 
                                        type="text" 
                                        placeholder="Tópico específico (Opcional)" 
                                        value={topic}
                                        onChange={e=>setTopic(e.target.value)}
                                        list="topics-list"
                                        className="w-full bg-slate-900 border border-slate-800 text-white p-4 rounded-xl outline-none placeholder:text-slate-600 text-sm"
                                    />
                                    <datalist id="topics-list">{TOPICS_BY_SUBJECT[subject] && TOPICS_BY_SUBJECT[subject].map(t => <option key={t} value={t} />)}</datalist>
                                </div>
                             )}

                            <button 
                                onClick={() => isRunning ? pauseTimer() : startTimer()}
                                className={`w-full py-5 rounded-2xl font-black text-xl tracking-widest shadow-xl flex items-center justify-center gap-2 touch-manipulation transition-all ${isRunning ? 'bg-amber-500 text-black' : 'bg-blue-600 text-white'}`}
                            >
                                {isRunning ? <><Icon name="pause" size={24}/> PAUSAR</> : <><Icon name="play" size={24}/> INICIAR</>}
                            </button>
                        </div>
                    )}

                    {((!isRunning && time !== initialTime && entryMode === 'timer') || entryMode === 'manual') && (
                        <div className="space-y-3 animate-fade-in bg-slate-900/90 backdrop-blur-md p-4 rounded-2xl border border-slate-700 shadow-2xl relative z-20">
                            {entryMode === 'timer' && stage === 'Questões' && (
                                <div className="grid grid-cols-2 gap-3">
                                    <input type="number" placeholder="Feitas" value={qDone} onChange={e=>setQDone(e.target.value)} className="bg-black border border-slate-700 p-3 rounded-xl text-white text-center outline-none focus:border-emerald-500 text-sm"/>
                                    <input type="number" placeholder="Acertos" value={qCorrect} onChange={e=>setQCorrect(e.target.value)} className="bg-black border border-slate-700 p-3 rounded-xl text-emerald-400 font-bold text-center outline-none focus:border-emerald-500 text-sm"/>
                                </div>
                            )}
                            
                            <button onClick={handleSave} className="w-full py-5 bg-emerald-600 active:bg-emerald-700 text-white text-lg font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 touch-manipulation">
                                <Icon name="save" size={24}/> {entryMode === 'timer' ? 'FINALIZAR E SALVAR' : 'REGISTRAR'}
                            </button>
                            
                            {entryMode === 'timer' && (
                                <button onClick={()=>{resetTimer(initialTime)}} className="w-full py-4 text-slate-500 text-sm font-bold border border-slate-800 rounded-xl">DESCARTAR</button>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );

        const DashboardView = ({ stats, sessions, onDeleteSession, onUpdateSession }) => {
            const [selectedSession, setSelectedSession] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [editForm, setEditForm] = useState({});

            const handleSelectSession = (s) => {
                setSelectedSession(s);
                setEditForm({...s}); 
                setIsEditing(false);
            };

            const handleDelete = () => {
                if (confirm('Confirma a exclusão deste registro?')) {
                    onDeleteSession(selectedSession.id);
                    setSelectedSession(null);
                }
            };

            const handleSaveEdit = () => {
                onUpdateSession(editForm);
                setSelectedSession(editForm);
                setIsEditing(false);
            };

            const handleEditChange = (field, value) => {
                setEditForm(prev => ({...prev, [field]: value}));
            };

            return (
                <div className="flex flex-col h-full p-6 pt-safe overflow-y-auto pb-24 fade-in">
                    <h2 className="text-xl font-bold text-white mb-6">Relatório de Campo</h2>
                    
                    {/* Monitor de Hoje e Semana */}
                    <div className="grid grid-cols-2 gap-3 mb-6">
                        <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 col-span-2 flex flex-col items-center justify-center relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-3 opacity-10"><Icon name="calendar-check" size={64}/></div>
                            <span className="text-slate-500 text-[10px] font-bold uppercase mb-1">HOJE</span>
                            <div className="text-5xl font-mono font-bold text-white">{formatDuration(stats.todayMins)}</div>
                            <div className="text-xs text-slate-500 mt-1 font-bold">META DIÁRIA</div>
                        </div>
                        <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 flex flex-col justify-center">
                            <span className="text-slate-500 text-[10px] font-bold uppercase">Total Semana</span>
                            <div className="text-2xl font-mono text-blue-400">{formatDuration(stats.weekTotal)}</div>
                        </div>
                        <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 flex flex-col justify-center">
                            <span className="text-slate-500 text-[10px] font-bold uppercase">Questões</span>
                            <div className="text-2xl font-mono text-emerald-400">{stats.totalQ}</div>
                        </div>
                    </div>

                    {/* Gráfico Semanal */}
                    <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 mb-6 min-h-[200px] flex flex-col">
                        <span className="text-slate-500 text-[10px] font-bold uppercase mb-4">Cadência Semanal</span>
                        <div className="flex-1 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={stats.weekData}>
                                    <Bar dataKey="minutes">
                                        {stats.weekData.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={entry.active ? '#10b981' : '#3b82f6'} radius={[4, 4, 0, 0]} />
                                        ))}
                                    </Bar>
                                    <XAxis dataKey="day" stroke="#64748b" fontSize={10} tickLine={false} axisLine={false} />
                                    <Tooltip 
                                        cursor={{fill: 'transparent'}}
                                        contentStyle={{backgroundColor: '#0f172a', borderColor: '#1e293b', borderRadius: '8px', fontSize: '12px'}}
                                        labelStyle={{color: '#94a3b8'}}
                                        formatter={(value) => [formatDuration(value), 'Tempo']}
                                    />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    
                    <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 mb-6 min-h-[250px] flex flex-col">
                        <span className="text-slate-500 text-[10px] font-bold uppercase mb-4">Distribuição Tática</span>
                        <div className="flex-1 w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie data={stats.byStage} innerRadius={50} outerRadius={70} paddingAngle={5} dataKey="value">
                                        {stats.byStage.map((e, i) => <Cell key={i} fill={e.fill} stroke="none"/>)}
                                    </Pie>
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="flex flex-wrap justify-center gap-3 mt-2">
                            {stats.byStage.map(s => (
                                <div key={s.name} className="flex items-center gap-1">
                                    <div className="w-2 h-2 rounded-full" style={{backgroundColor: s.fill}}></div>
                                    <span className="text-[10px] text-slate-400">{s.name}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div>
                        <span className="text-slate-500 text-[10px] font-bold uppercase mb-2 block">Últimas Missões</span>
                        <div className="space-y-3">
                            {sessions.slice(0, 8).map(s => (
                                <div 
                                    key={s.id} 
                                    onClick={() => handleSelectSession(s)}
                                    className="bg-slate-900 p-3 rounded-xl border border-slate-800 flex justify-between items-center active:bg-slate-800 cursor-pointer transition-colors"
                                >
                                    <div>
                                        <div className={`text-sm font-bold ${SUBJECT_COLORS[s.subject] || 'text-white'}`}>{s.subject}</div>
                                        <div className="text-[10px] text-slate-500">{s.date.split('-').reverse().join('/')} • {s.stage}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-sm font-mono text-blue-400">{formatDuration(s.minutes)}</div>
                                        {s.questions > 0 && <div className="text-[10px] text-emerald-500 font-bold">{Math.round((s.correct/s.questions)*100)}%</div>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Modal de Detalhes */}
                    {selectedSession && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in" onClick={() => setSelectedSession(null)}>
                            <div className="bg-slate-900 border border-slate-700 w-full max-w-sm p-6 rounded-2xl shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setSelectedSession(null)} className="absolute top-4 right-4 text-slate-400 hover:text-white"><Icon name="x" size={20}/></button>
                                
                                {isEditing ? (
                                    <div className="space-y-4 pt-4">
                                        {/* FORMULÁRIO DE EDIÇÃO */}
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Matéria</label>
                                                <select value={editForm.subject} onChange={e=>handleEditChange('subject', e.target.value)} className="bg-black border border-slate-700 text-white p-2 rounded-lg text-xs w-full">
                                                    {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Etapa</label>
                                                <select value={editForm.stage} onChange={e=>handleEditChange('stage', e.target.value)} className="bg-black border border-slate-700 text-white p-2 rounded-lg text-xs w-full">
                                                    {STAGES.map(s=><option key={s} value={s}>{s}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Tópico</label>
                                            <input type="text" value={editForm.topic} onChange={e=>handleEditChange('topic', e.target.value)} className="bg-black border border-slate-700 text-white p-2 rounded-lg text-xs w-full"/>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Data</label>
                                                <input type="date" value={editForm.date} onChange={e=>handleEditChange('date', e.target.value)} className="bg-black border border-slate-700 text-white p-2 rounded-lg text-xs w-full"/>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Minutos</label>
                                                <input type="number" value={editForm.minutes} onChange={e=>handleEditChange('minutes', parseInt(e.target.value))} className="bg-black border border-slate-700 text-white p-2 rounded-lg text-xs w-full"/>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Questões</label>
                                                <input type="number" value={editForm.questions} onChange={e=>handleEditChange('questions', parseInt(e.target.value))} className="bg-black border border-slate-700 text-white p-2 rounded-lg text-xs w-full"/>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Acertos</label>
                                                <input type="number" value={editForm.correct} onChange={e=>handleEditChange('correct', parseInt(e.target.value))} className="bg-black border border-slate-700 text-white p-2 rounded-lg text-xs w-full"/>
                                            </div>
                                        </div>

                                        <div className="flex gap-2 mt-4">
                                            <button onClick={() => setIsEditing(false)} className="flex-1 py-3 text-slate-400 text-xs font-bold border border-slate-700 rounded-xl">CANCELAR</button>
                                            <button onClick={handleSaveEdit} className="flex-1 py-3 bg-blue-600 text-white text-xs font-bold rounded-xl shadow-lg">SALVAR ALTERAÇÕES</button>
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        {/* VISUALIZAÇÃO PADRÃO COM BOTÃO EDITAR REINSERIDO */}
                                        <div className="flex items-center justify-between mb-1">
                                            <h3 className={`text-lg font-bold ${SUBJECT_COLORS[selectedSession.subject] || 'text-white'}`}>{selectedSession.subject}</h3>
                                            <button onClick={() => setIsEditing(true)} className="text-blue-500 p-2"><Icon name="pencil" size={18}/></button>
                                        </div>
                                        <p className="text-xs text-blue-400 font-bold uppercase mb-6">{selectedSession.stage}</p>
                                        
                                        <div className="space-y-4 mb-6">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-500 uppercase block">Tópico</label>
                                                <p className="text-sm text-slate-300">{selectedSession.topic || "Geral"}</p>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-500 uppercase block">Tempo</label>
                                                    <p className="text-lg font-mono text-white">{formatDuration(selectedSession.minutes)}</p>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-500 uppercase block">Data</label>
                                                    <p className="text-sm text-slate-300 mt-1">{selectedSession.date.split('-').reverse().join('/')}</p>
                                                </div>
                                            </div>
                                            {selectedSession.questions > 0 && (
                                                <div className="bg-slate-950 p-3 rounded-lg border border-slate-800">
                                                    <label className="text-[10px] font-bold text-slate-500 uppercase block mb-1">Desempenho</label>
                                                    <div className="flex justify-between items-end">
                                                        <span className="text-sm text-slate-300">{selectedSession.questions} Questões</span>
                                                        <span className="text-lg font-bold text-emerald-400">{Math.round((selectedSession.correct/selectedSession.questions)*100)}% Acerto</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        
                                        <button 
                                            onClick={handleDelete}
                                            className="w-full py-3 bg-red-500/10 text-red-500 border border-red-500/30 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-red-500/20 transition-colors"
                                        >
                                            <Icon name="trash-2" size={16}/> EXCLUIR REGISTRO
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const NotesView = ({ notes, user, isCloudActive, onSaveNote, onDeleteNote }) => {
            const [noteText, setNoteText] = useState('');
            const [noteSubject, setNoteSubject] = useState(SUBJECTS[0]);
            const [isListening, setIsListening] = useState(false);
            const recognitionRef = useRef(null);

            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.interimResults = false; 
                    recognition.lang = 'pt-BR';

                    recognition.onresult = (event) => {
                        let finalTranscript = '';
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                finalTranscript += event.results[i][0].transcript;
                            }
                        }
                        setNoteText(prev => {
                            const spacer = (prev.length > 0 && !['.', ',', '!', '?'].includes(finalTranscript[0])) ? ' ' : '';
                            return prev + spacer + finalTranscript;
                        });
                    };

                    recognition.onend = () => setIsListening(false);
                    recognitionRef.current = recognition;
                }
            }, []);

            const toggleMic = () => {
                if (!recognitionRef.current) return alert("Navegador sem suporte a voz.");
                
                if (isListening) {
                    recognitionRef.current.stop();
                } else {
                    try {
                        recognitionRef.current.start();
                        setIsListening(true);
                    } catch(e) {
                        console.error(e);
                    }
                }
            };

            const handleAdd = () => {
                onSaveNote(noteText, noteSubject);
                setNoteText('');
            };

            return (
                <div className="flex flex-col h-full p-6 pt-safe fade-in">
                    <h2 className="text-xl font-bold text-white mb-6">Caderno de Campo</h2>
                    <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 mb-6 space-y-3">
                        <div className="flex flex-col gap-1">
                            <label className="text-[10px] font-bold text-slate-500 uppercase">Matéria</label>
                            <select 
                                value={noteSubject} 
                                onChange={(e) => setNoteSubject(e.target.value)}
                                className="bg-black border border-slate-700 text-white p-3 rounded-xl outline-none font-bold text-xs w-full appearance-none"
                            >
                                {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>

                        <div className="relative">
                            <textarea 
                                value={noteText} onChange={e=>setNoteText(e.target.value)}
                                placeholder="Anotar insight, artigo ou súmula... (Use o microfone para ditar)"
                                className="w-full h-32 bg-transparent text-white text-sm outline-none resize-none placeholder:text-slate-600 border-t border-slate-800 pt-3"
                            ></textarea>
                            <button 
                                onClick={toggleMic}
                                className={`absolute bottom-2 right-2 p-2 rounded-full transition-all ${isListening ? 'bg-red-600 text-white animate-pulse' : 'bg-slate-800 text-slate-400'}`}
                                title="Gravar Nota de Voz"
                            >
                                <Icon name={isListening ? "mic-off" : "mic"} size={20} />
                            </button>
                        </div>

                        <div className="flex justify-end">
                            <button onClick={handleAdd} className="px-4 py-2 bg-blue-600 rounded-lg text-xs font-bold text-white shadow-lg w-full">SALVAR NOTA</button>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto space-y-3 pb-24">
                        {notes.map(n => (
                            <div key={n.id} className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 relative group">
                                <button 
                                    onClick={() => onDeleteNote(n.id)}
                                    className="absolute top-2 right-2 text-slate-600 hover:text-red-500 p-2 z-10"
                                >
                                    <Icon name="trash-2" size={16} />
                                </button>
                                <div className="flex justify-between items-start mb-2 pr-8">
                                    <span className="text-[10px] font-bold bg-blue-900/30 text-blue-400 px-2 py-1 rounded border border-blue-500/30">{n.subject}</span>
                                    <span className="text-[10px] text-slate-500 font-mono">{n.date} {n.time}</span>
                                </div>
                                <p className="text-sm text-slate-300 whitespace-pre-wrap">{n.text}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- NOVA ABA: ANÁLISE ESTRATÉGICA ---
        const AnalyticsView = ({ stats, sessions }) => {
            
            // 1. Calcular Tópicos Não Estudados (Gap Analysis)
            const missingTopics = useMemo(() => {
                const studiedTopics = new Set(sessions.map(s => `${s.subject}-${s.topic}`));
                const gaps = [];

                SUBJECTS.forEach(sub => {
                    const topics = TOPICS_BY_SUBJECT[sub];
                    if (topics) {
                        topics.forEach(t => {
                            if (!studiedTopics.has(`${sub}-${t}`)) {
                                gaps.push({ subject: sub, topic: t });
                            }
                        });
                    }
                });
                return gaps;
            }, [sessions]);

            // 2. Calcular Pontos de Melhoria
            const improvementPoints = useMemo(() => {
                const points = [];
                // Baixo volume de questões global
                if (stats.totalMins > 0) {
                     const qTime = stats.byStage.find(s => s.name === 'Questões')?.value || 0;
                     if ((qTime / stats.totalMins) < 0.20) {
                         points.push({ type: 'CRÍTICO', msg: 'Volume de Questões abaixo de 20%.' });
                     }
                }
                // Matéria Zerada
                stats.bySub.forEach(sub => {
                    if (sub.minutes === 0) points.push({ type: 'ALERTA', msg: `Nenhum estudo em ${sub.subject}.` });
                });
                return points;
            }, [stats]);

            return (
                <div className="flex flex-col h-full p-6 pt-safe overflow-y-auto pb-24 fade-in">
                    <h2 className="text-xl font-bold text-white mb-6">Inteligência Estratégica</h2>

                    {/* Alertas de Melhoria */}
                    {improvementPoints.length > 0 && (
                        <div className="mb-8 space-y-3">
                            <span className="text-slate-500 text-[10px] font-bold uppercase">Pontos de Atenção</span>
                            {improvementPoints.map((p, i) => (
                                <div key={i} className={`p-3 rounded-xl border flex items-center gap-3 ${p.type === 'CRÍTICO' ? 'bg-red-900/20 border-red-800 text-red-300' : 'bg-amber-900/20 border-amber-800 text-amber-300'}`}>
                                    <Icon name="alert-circle" size={18} />
                                    <span className="text-xs font-bold">{p.msg}</span>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Tempo por Matéria (Bar Chart Simples) */}
                    <div className="mb-8">
                        <span className="text-slate-500 text-[10px] font-bold uppercase mb-3 block">Raio-X por Matéria</span>
                        <div className="space-y-3">
                            {stats.bySub.map(sub => (
                                <div key={sub.subject}>
                                    <div className="flex justify-between text-xs mb-1">
                                        <span className="text-slate-300">{sub.subject}</span>
                                        <span className="text-slate-500 font-mono">{formatDuration(sub.minutes)}</span>
                                    </div>
                                    <div className="w-full bg-slate-900 rounded-full h-2">
                                        <div 
                                            className="bg-blue-600 h-2 rounded-full" 
                                            style={{ width: `${stats.totalMins > 0 ? (sub.minutes / stats.totalMins) * 100 : 0}%` }}
                                        ></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Tempo por Etapa */}
                    <div className="mb-8">
                         <span className="text-slate-500 text-[10px] font-bold uppercase mb-3 block">Raio-X por Etapa</span>
                         <div className="grid grid-cols-2 gap-3">
                             {stats.byStage.map(st => (
                                 <div key={st.name} className="bg-slate-900 p-3 rounded-xl border border-slate-800">
                                     <span className="text-[10px] text-slate-500 uppercase block mb-1" style={{color: st.fill}}>{st.name}</span>
                                     <span className="text-lg font-mono font-bold text-white">{formatDuration(st.value)}</span>
                                 </div>
                             ))}
                         </div>
                    </div>

                    {/* Tópicos Não Estudados (Pareto) */}
                    <div>
                        <span className="text-slate-500 text-[10px] font-bold uppercase mb-3 block">Tópicos Prioritários Pendentes</span>
                        {missingTopics.length === 0 ? (
                            <div className="p-4 bg-emerald-900/20 border border-emerald-800 rounded-xl text-center">
                                <span className="text-emerald-400 text-xs font-bold">Ciclo Completo! Parabéns.</span>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                {missingTopics.slice(0, 10).map((gap, i) => (
                                    <div key={i} className="flex items-center gap-3 p-3 bg-slate-900/50 border border-slate-800 rounded-xl opacity-70">
                                        <div className="w-1.5 h-1.5 rounded-full bg-slate-600"></div>
                                        <div>
                                            <div className="text-xs text-slate-300 font-bold">{gap.topic}</div>
                                            <div className="text-[10px] text-slate-600 uppercase">{gap.subject}</div>
                                        </div>
                                    </div>
                                ))}
                                {missingTopics.length > 10 && (
                                    <div className="text-center text-xs text-slate-600 mt-2">
                                        + {missingTopics.length - 10} tópicos pendentes...
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                </div>
            );
        };

        function DeltaMobile() {
            // --- ESTADO INICIAL DO LOCAL STORAGE (LOCAL-FIRST) ---
            const [user, setUser] = useState(null);
            const [tab, setTab] = useState('timer');
            const [sessions, setSessions] = useState(() => JSON.parse(localStorage.getItem('delta_sessions') || '[]'));
            const [notes, setNotes] = useState(() => JSON.parse(localStorage.getItem('delta_notes') || '[]'));
            
            // Timer & Entry Mode
            const [entryMode, setEntryMode] = useState('timer');
            const [isRunning, setIsRunning] = useState(false);
            const [time, setTime] = useState(50 * 60);
            const [initialTime, setInitialTime] = useState(50 * 60);
            const [endTime, setEndTime] = useState(null);
            
            // Dados Sessão
            const [subject, setSubject] = useState(SUBJECTS[0]);
            const [stage, setStage] = useState(STAGES[0]);
            const [topic, setTopic] = useState('');
            // CORREÇÃO: "HOJE" TÁTICO
            const getLocalISODate = () => {
                const d = new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const [manualDate, setManualDate] = useState(getLocalISODate());
            const [manualHours, setManualHours] = useState('');
            const [manualMins, setManualMins] = useState('');
            
            // Stats
            const [qDone, setQDone] = useState('');
            const [qCorrect, setQCorrect] = useState('');
            
            const wakeLockRef = useRef(null);
            
            // Estado de Conexão
            const [connectionStatus, setConnectionStatus] = useState('offline');

            // --- REORGANIZAÇÃO DE FUNÇÕES (CORREÇÃO DE ESCOPO) ---

            const forceLogin = () => {
                if (isConfigLoaded) {
                    setConnectionStatus('connecting');
                    auth.signInAnonymously()
                        .then(u => {
                            setUser(u.user);
                            setConnectionStatus('online');
                            alert("STATUS: Conectado à Nuvem (Firebase).");
                        })
                        .catch(error => {
                            console.error("Erro Login:", error);
                            setConnectionStatus('offline');
                            alert(`ERRO: ${error.message}`);
                        });
                } else {
                    alert("Configuração do Firebase não carregada.");
                }
            };

            const runDiagnostics = () => {
                 if(connectionStatus === 'offline' || connectionStatus === 'connecting') {
                     forceLogin();
                 } else {
                     let msg = `STATUS: ${connectionStatus.toUpperCase()}\n`;
                     msg += `Modo: ${isConfigLoaded ? 'Híbrido' : 'Local'}\n`;
                     msg += `Dados Locais: ${sessions.length} sessões.\n`;
                     alert(msg);
                 }
            };

            const pauseTimer = () => {
                setIsRunning(false);
                setEndTime(null);
            };

            const startTimer = () => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) { const ctx = new AudioContext(); ctx.resume(); }
                setEndTime(Date.now() + time * 1000);
                setIsRunning(true);
            };

            const resetTimer = (newTime) => {
                setIsRunning(false);
                setEndTime(null);
                setTime(newTime);
                setInitialTime(newTime);
            };

            // --- EFEITOS E SINCRONIA ---

            // 1. Notificações
            useEffect(() => {
                if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
            }, []);

            // 2. Auth e Sincronia com Nuvem
            useEffect(() => {
                if (isConfigLoaded) {
                    setConnectionStatus('connecting');
                    auth.signInAnonymously()
                        .then(u => {
                            setUser(u.user);
                            setConnectionStatus('online');
                        })
                        .catch(err => {
                            console.log("Auth Falhou:", err);
                            setConnectionStatus('offline');
                        });
                }
            }, []);

            // 3. Carregar da Nuvem (Se disponível) e mesclar/atualizar
            useEffect(() => {
                if (user && isConfigLoaded) {
                    const sessRef = db.collection('users').doc(user.uid).collection('sessions').orderBy('createdAt', 'desc').limit(50);
                    const notesRef = db.collection('users').doc(user.uid).collection('notes').orderBy('createdAt', 'desc');

                    const unsubSess = sessRef.onSnapshot(snap => {
                        const cloudSessions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        if (cloudSessions.length > 0) {
                            setSessions(cloudSessions);
                            localStorage.setItem('delta_sessions', JSON.stringify(cloudSessions));
                        }
                    });

                    const unsubNotes = notesRef.onSnapshot(snap => {
                        const cloudNotes = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        if (cloudNotes.length > 0) {
                            setNotes(cloudNotes);
                            localStorage.setItem('delta_notes', JSON.stringify(cloudNotes));
                        }
                    });

                    return () => { unsubSess(); unsubNotes(); };
                }
            }, [user]);

            useEffect(() => { if (!isRunning) setTopic(''); }, [subject]);

            const toggleWakeLock = async (shouldLock) => {
                try {
                    if (shouldLock && 'wakeLock' in navigator) {
                        wakeLockRef.current = await navigator.wakeLock.request('screen');
                    } else if (!shouldLock && wakeLockRef.current) {
                        await wakeLockRef.current.release();
                        wakeLockRef.current = null;
                    }
                } catch (err) { console.log(err); }
            };

            // Timer Tick
            useEffect(() => {
                let interval;
                if (isRunning) {
                    toggleWakeLock(true);
                    if (!endTime) setEndTime(Date.now() + time * 1000);

                    interval = setInterval(() => {
                        const now = Date.now();
                        const remaining = Math.ceil((endTime - now) / 1000);
                        if (remaining <= 0) {
                            setTime(0); setIsRunning(false); setEndTime(null); toggleWakeLock(false); playAlert(); clearInterval(interval);
                        } else {
                            setTime(remaining);
                        }
                    }, 1000);
                } else {
                    toggleWakeLock(false); setEndTime(null);
                }
                return () => clearInterval(interval);
            }, [isRunning, endTime]);

            // --- AÇÕES ---

            const handleSave = async () => {
                let duration, dateSess;

                if (entryMode === 'timer') {
                    duration = Math.round((initialTime - time) / 60);
                    // Use local date for timer save
                    const d = new Date();
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dateSess = `${year}-${month}-${day}`;
                } else {
                    const h = parseInt(manualHours) || 0;
                    const m = parseInt(manualMins) || 0;
                    duration = (h * 60) + m;
                    dateSess = manualDate;
                }

                if (!duration || duration < 1) return alert("Sessão inválida.");

                const newSess = {
                    id: Date.now().toString(), // ID local temporário
                    date: dateSess, subject, stage, topic: topic || 'Geral',
                    minutes: duration, questions: parseInt(qDone) || 0, correct: parseInt(qCorrect) || 0,
                    createdAt: Date.now()
                };

                // 1. Salvar Localmente Sempre (Backup Imediato)
                const updatedSessions = [newSess, ...sessions];
                setSessions(updatedSessions);
                localStorage.setItem('delta_sessions', JSON.stringify(updatedSessions));

                // 2. Tentar Salvar na Nuvem
                if (user && isConfigLoaded) {
                    try {
                        const { id, ...cloudSess } = newSess;
                        await db.collection('users').doc(user.uid).collection('sessions').add(cloudSess);
                    } catch (e) {
                        console.log("Salvo apenas localmente (Erro Sync)");
                    }
                }
                
                resetTimer(initialTime); setTopic(''); setQDone(''); setQCorrect(''); setManualHours(''); setManualMins('');
                const btn = document.activeElement;
                if(btn) { btn.innerText = "REGISTRADO"; setTimeout(() => btn.innerText = "REGISTRAR", 1500); }
            };

            const handleDeleteSession = async (id) => {
                // 1. Delete Local
                const updatedSessions = sessions.filter(s => s.id !== id);
                setSessions(updatedSessions);
                localStorage.setItem('delta_sessions', JSON.stringify(updatedSessions));

                // 2. Delete Cloud
                if (user && isConfigLoaded) {
                    try {
                        await db.collection('users').doc(user.uid).collection('sessions').doc(id).delete();
                    } catch (e) { console.error("Erro delete nuvem", e); }
                }
            };
            
            const handleUpdateSession = async (updatedSession) => {
                // 1. Update Local State immediately for responsiveness
                const newSessions = sessions.map(s => s.id === updatedSession.id ? updatedSession : s);
                setSessions(newSessions);
                localStorage.setItem('delta_sessions', JSON.stringify(newSessions));

                // 2. Update Cloud if connected
                if (user && isConfigLoaded && user.uid !== 'local') {
                    try {
                        const { id, ...dataToUpdate } = updatedSession;
                        // Firestore update needs object without id
                        await db.collection('users').doc(user.uid).collection('sessions').doc(id).update(dataToUpdate);
                    } catch (e) {
                        console.error("Erro update nuvem", e);
                    }
                }
            };

            const onDeleteNote = async (id) => {
                if(!confirm("Excluir esta nota permanentemente?")) return;

                // 1. Delete Local
                const updatedNotes = notes.filter(n => n.id !== id);
                setNotes(updatedNotes);
                localStorage.setItem('delta_notes', JSON.stringify(updatedNotes));

                // 2. Delete Cloud
                if (user && isConfigLoaded) {
                    try {
                        await db.collection('users').doc(user.uid).collection('notes').doc(id).delete();
                    } catch (e) { console.error("Erro delete nuvem", e); }
                }
            };

            const onSaveNote = async (text, subject) => {
                if(!text.trim()) return;
                const now = new Date();
                const newNote = {
                    id: Date.now().toString(),
                    text, 
                    createdAt: Date.now(), 
                    subject: subject || 'Geral', 
                    date: now.toLocaleDateString('pt-BR'), 
                    time: now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})
                };

                // 1. Local
                const updatedNotes = [newNote, ...notes];
                setNotes(updatedNotes);
                localStorage.setItem('delta_notes', JSON.stringify(updatedNotes));

                // 2. Cloud
                if (user && isConfigLoaded) {
                    const { id, ...cloudNote } = newNote;
                    await db.collection('users').doc(user.uid).collection('notes').add(cloudNote);
                }
            };

            // Cálculo Estendido para Analytics
            const stats = useMemo(() => {
                // Métricas Globais
                const totalMins = sessions.reduce((acc, s) => acc + s.minutes, 0);
                const totalQ = sessions.reduce((acc, s) => acc + (s.questions || 0), 0);
                
                const byStage = STAGES.map(st => ({
                    name: st, 
                    value: sessions.filter(s => s.stage === st).reduce((acc, s) => acc + s.minutes, 0), 
                    fill: STAGE_COLORS[st]
                }));
                
                const bySub = SUBJECTS.map(sub => ({
                    subject: sub,
                    minutes: sessions.filter(s => s.subject === sub).reduce((acc, s) => acc + s.minutes, 0)
                }));

                // Métricas Temporais (Hoje e Semana)
                // Use local date string for comparison to match manual input
                const d = new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`;
                
                // Hoje
                const todayMins = sessions
                    .filter(s => s.date === todayStr)
                    .reduce((acc, s) => acc + s.minutes, 0);

                // Semana Corrente (Segunda a Domingo)
                const now = new Date();
                const dayOfWeek = now.getDay(); // 0 (Dom) a 6 (Sab)
                const distanceToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                const monday = new Date(now);
                monday.setDate(now.getDate() - distanceToMonday);
                monday.setHours(0,0,0,0);
                
                // Filtra sessões da semana
                const weekSessions = sessions.filter(s => {
                    const d = new Date(s.date + 'T00:00:00');
                    return d >= monday;
                });

                const weekTotal = weekSessions.reduce((acc, s) => acc + s.minutes, 0);

                // Dados para o Gráfico de Barra (Seg-Dom)
                const weekDays = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
                const weekData = weekDays.map((dayName, index) => {
                    // Calcula a data para cada dia da semana atual
                    const current = new Date(monday);
                    current.setDate(monday.getDate() + index);
                    
                    const cy = current.getFullYear();
                    const cm = String(current.getMonth() + 1).padStart(2, '0');
                    const cd = String(current.getDate()).padStart(2, '0');
                    const dateStr = `${cy}-${cm}-${cd}`;
                    
                    const minutes = sessions
                        .filter(s => s.date === dateStr)
                        .reduce((acc, s) => acc + s.minutes, 0);
                        
                    return { 
                        day: dayName, 
                        minutes,
                        active: index === (dayOfWeek === 0 ? 6 : dayOfWeek - 1)
                    };
                });
                
                return { totalMins, totalQ, byStage, bySub, todayMins, weekTotal, weekData };
            }, [sessions]);

            return (
                <div className="flex flex-col h-full w-full bg-black">
                    <div className="flex-1 overflow-hidden relative">
                        {tab === 'timer' && (
                            <TimerView 
                                user={user} isCloudActive={isConfigLoaded} connectionStatus={connectionStatus} runDiagnostics={runDiagnostics}
                                entryMode={entryMode} setEntryMode={setEntryMode} 
                                isRunning={isRunning} time={time} initialTime={initialTime} 
                                subject={subject} setSubject={setSubject} 
                                stage={stage} setStage={setStage} 
                                topic={topic} setTopic={setTopic} 
                                manualDate={manualDate} setManualDate={setManualDate} 
                                manualHours={manualHours} setManualHours={setManualHours}
                                manualMins={manualMins} setManualMins={setManualMins}
                                qDone={qDone} setQDone={setQDone} 
                                qCorrect={qCorrect} setQCorrect={setQCorrect} 
                                resetTimer={resetTimer} handleSave={handleSave} 
                                formatTime={formatTime} pauseTimer={pauseTimer} startTimer={startTimer}
                                forceLogin={forceLogin}
                            />
                        )}
                        {tab === 'dashboard' && <DashboardView stats={stats} sessions={sessions} onDeleteSession={handleDeleteSession} onUpdateSession={handleUpdateSession} />}
                        {tab === 'notes' && <NotesView notes={notes} user={user} isCloudActive={isConfigLoaded} onSaveNote={onSaveNote} onDeleteNote={onDeleteNote} />}
                        {tab === 'analytics' && <AnalyticsView stats={stats} sessions={sessions} />}
                    </div>
                    <nav className="h-16 bg-[#0a0a0a] border-t border-slate-900 grid grid-cols-4 pb-safe pt-1">
                        <button onClick={()=>setTab('dashboard')} className={`flex flex-col items-center justify-center gap-1 ${tab==='dashboard'?'text-blue-500':'text-slate-600'}`}>
                            <Icon name="layout-dashboard" size={20}/>
                            <span className="text-[10px] font-bold">Painel</span>
                        </button>
                        <button onClick={()=>setTab('timer')} className={`flex flex-col items-center justify-center gap-1 ${tab==='timer'?'text-blue-500':'text-slate-600'}`}>
                            <Icon name="target" size={20}/>
                            <span className="text-[10px] font-bold">Foco</span>
                        </button>
                        <button onClick={()=>setTab('notes')} className={`flex flex-col items-center justify-center gap-1 ${tab==='notes'?'text-blue-500':'text-slate-600'}`}>
                            <Icon name="sticky-note" size={20}/>
                            <span className="text-[10px] font-bold">Notas</span>
                        </button>
                        <button onClick={()=>setTab('analytics')} className={`flex flex-col items-center justify-center gap-1 ${tab==='analytics'?'text-blue-500':'text-slate-600'}`}>
                            <Icon name="bar-chart-2" size={20}/>
                            <span className="text-[10px] font-bold">Estratégia</span>
                        </button>
                    </nav>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<DeltaMobile />);
    </script>
</body>
</html>